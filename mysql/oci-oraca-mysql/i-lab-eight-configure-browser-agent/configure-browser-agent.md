# Instrument the browser monitoring

## Introduction

In the previous lab, you instrumented the application with an APM java agent, which captures traces and spans generated by the server. In this lab, you will configure an APM browser agent that captures traces and spans generated by the browser. You will insert a javascript to the application's index.html file to deploy the APM browser agent.

To simplify the application setup process in this workshop, the webpage to instrument (index.html) is located in a Kubernetes pod. You will copy the file from the container, edit the file by injecting the JavaScript, then copy it back into the container.  


Please note that these changes will be lost when the pods are recreated. This setup is only to keep the lab steps simple. In the real use cases, you will need the changes preconfigured in the image, or deploy the static content to the shared location so that the changes will be kept when Kubernetes pods are recreated.


Estimated time: 5 minutes

### Objectives

* Instrument browser by injecting JavaScript code to the webpage

### Prerequisites

* Completion of the preceding labs in this workshop

## Task 1: Copy a webpage from the container


1. Run the oci ce (Container Engine) command that was saved in Lab 6, Task 2, step 4.

2. Execute the following command to copy ***index.html*** from the container to the home directory.

    ``` bash
    <copy>
    cd ~/;kubectl cp wstore-front-0:static/index.html ./index.html
    </copy>
    ```

3.	Run the "ls -l" command in the home directory, to verify that the file is transferred to the Cloud Shell.

    ``` bash
    <copy>
    ls
    </copy>
    ```

   ![Oracle Cloud console, Cloud Shell](images/8-1-1-browseragent.png " ")

## Task 2: Update the webpage with APM browser agent injection
1.	Open the index.html with an editor.

    ```bash
    <copy>
    vi ~/index.html
    </copy>
    ```

2. Insert the following JavaScript to the index.html file, just below the &lt;/head&gt; tag. Replace **Data Upload Endpoint** and the **Public Data key**. Note that there are two locations you will need to replace the Data Upload Endpoint.


    ```bash
    <copy>
    <script>
    window.apmrum = (window.apmrum || {});
    window.apmrum.serviceName='wstore-web';
    window.apmrum.webApplication='WStore App';
    window.apmrum.ociDataUploadEndpoint='<DataUploadEndpoint>';
    window.apmrum.OracleAPMPublicDataKey='<Public_Datakey>';
    window.apmrum.traceSupportingEndpoints =  [ { headers: [ 'APM' ], hostPattern: '.*' } ];
    </script>
    <script async crossorigin="anonymous" src="<DataUploadEndpoint>/static/jslib/apmrum.min.js"></script>
    </copy>
    ```
    Save the changes and close the file.

    ![Oracle Cloud console, Cloud Shell](images/8-1-2-browseragent.png " ")

## Task 3: Copy the webpage back to the container

1. Execute the following command to copy the ***index.html*** file back to the container.

     ``` bash
     <copy>
     cd ~/;kubectl cp ./index.html wstore-front-0:static/index.html
     </copy>
     ```
  ![Oracle Cloud console, Cloud Shell](images/8-1-3-browseragent.png " ")

2. Verify the successful file transfer, by running the following command.


    ``` bash
    <copy>
    kubectl exec -it wstore-front-0 -- bash -c "cd static && cat index.html "
    </copy>
    ```
    Ensure you see the changes made in the previous step.

    ![Oracle Cloud console, Cloud Shell](images/8-1-4-browseragent.png " ")

    In the next lab, you will see application traces starting from the browser.   


You may now **proceed to the next lab**.

## Acknowledgements

* **Author** - Anand Prabhu, Principal Member of Technical Staff, Enterprise and Cloud Manageability
- **Contributors** -
Yutaka Takatsu, Senior Principal Product Manager,  
Avi Huber, Vice President, Product Management
* **Last Updated By/Date** - Anand Prabhu, January 2024